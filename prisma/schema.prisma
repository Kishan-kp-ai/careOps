generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ───────────────────────────────────────────────────────────────────

enum MemberRole {
  OWNER
  STAFF
}

enum WorkspaceStatus {
  DRAFT
  ACTIVE
}

enum ChannelType {
  EMAIL
  SMS
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum MessageStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
  RECEIVED
}

enum BookingStatus {
  REQUESTED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum EventType {
  LEAD_CREATED
  BOOKING_CREATED
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  FORM_SUBMITTED
  INVENTORY_LOW
  MESSAGE_INBOUND
}

// ─── NextAuth Adapter Models ─────────────────────────────────────────────────

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ─── Core Models ─────────────────────────────────────────────────────────────

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts    Account[]
  sessions    Session[]
  memberships WorkspaceMember[]
}

model Workspace {
  id           String          @id @default(cuid())
  name         String
  slug         String          @unique
  status       WorkspaceStatus @default(DRAFT)
  timezone     String          @default("UTC")
  address      String?
  contactEmail String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  members         WorkspaceMember[]
  channelAccounts ChannelAccount[]
  bookingTypes    BookingType[]
  customers       Customer[]
  leads           Lead[]
  conversations   Conversation[]
  bookings        Booking[]
  formDefinitions FormDefinition[]
  inventoryItems  InventoryItem[]
  automationRules AutomationRule[]
  eventLogs       EventLog[]
}

model WorkspaceMember {
  id          String     @id @default(cuid())
  workspaceId String
  userId      String
  role        MemberRole @default(STAFF)
  permissions Json?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
}

model ChannelAccount {
  id          String      @id @default(cuid())
  workspaceId String
  type        ChannelType
  provider    String      @default("mock")
  fromAddress String?
  fromNumber  String?
  config      Json?
  isActive    Boolean     @default(true)

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, type])
}

model Customer {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  email       String?
  phone       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace     Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  leads         Lead[]
  bookings      Booking[]
  conversations Conversation[]

  @@index([workspaceId])
  @@index([workspaceId, email])
}

model Lead {
  id          String   @id @default(cuid())
  workspaceId String
  customerId  String
  source      String   @default("contact_form")
  message     String?
  status      String   @default("new")
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace    Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer     Customer      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversation Conversation?

  @@index([workspaceId, status])
}

model Conversation {
  id                  String      @id @default(cuid())
  workspaceId         String
  customerId          String
  leadId              String?     @unique
  bookingId           String?     @unique
  subject             String?
  lastMessageAt       DateTime?
  isAutomationPaused  Boolean     @default(false)
  gmailThreadId       String?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customer  Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)
  lead      Lead?     @relation(fields: [leadId], references: [id], onDelete: SetNull)
  booking   Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  messages  Message[]

  @@index([workspaceId, lastMessageAt])
}

model Message {
  id             String           @id @default(cuid())
  conversationId String
  channel        ChannelType
  direction      MessageDirection
  status         MessageStatus    @default(QUEUED)
  fromAddress    String?
  toAddress      String?
  subject        String?
  body           String
  providerRef    String?
  sentAt         DateTime?
  receivedAt     DateTime?
  createdAt      DateTime         @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
}

model BookingType {
  id            String   @id @default(cuid())
  workspaceId   String
  name          String
  description   String?
  durationMin   Int      @default(60)
  location      String?
  isActive      Boolean  @default(true)
  availability  Json?
  linkedFormIds String[]

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  bookings  Booking[]

  @@index([workspaceId, isActive])
}

model Booking {
  id               String        @id @default(cuid())
  workspaceId      String
  bookingTypeId    String
  customerId       String
  status           BookingStatus @default(REQUESTED)
  startAt          DateTime
  endAt            DateTime
  notes            String?
  assignedMemberId String?
  publicToken      String        @unique @default(uuid())

  workspace      Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  bookingType    BookingType      @relation(fields: [bookingTypeId], references: [id], onDelete: Cascade)
  customer       Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  conversation   Conversation?
  formAssignments FormAssignment[]

  @@index([workspaceId, startAt])
  @@index([workspaceId, status])
}

model FormDefinition {
  id          String  @id @default(cuid())
  workspaceId String
  name        String
  description String?
  fields      Json
  isActive    Boolean @default(true)

  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  assignments FormAssignment[]

  @@index([workspaceId])
}

model FormAssignment {
  id          String    @id @default(cuid())
  workspaceId String
  bookingId   String
  formId      String
  status      String    @default("pending")
  sentAt      DateTime?
  completedAt DateTime?

  booking    Booking         @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  form       FormDefinition  @relation(fields: [formId], references: [id], onDelete: Cascade)
  submission FormSubmission?

  @@index([workspaceId, status])
}

model FormSubmission {
  id           String   @id @default(cuid())
  assignmentId String   @unique
  data         Json
  submittedAt  DateTime @default(now())

  assignment FormAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
}

model InventoryItem {
  id                String  @id @default(cuid())
  workspaceId       String
  name              String
  sku               String?
  quantity          Int     @default(0)
  lowStockThreshold Int     @default(5)
  unit              String?
  isActive          Boolean @default(true)

  workspace    Workspace              @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  transactions InventoryTransaction[]

  @@index([workspaceId])
}

model InventoryTransaction {
  id          String   @id @default(cuid())
  workspaceId String
  itemId      String
  type        String
  delta       Int
  note        String?
  bookingId   String?
  createdAt   DateTime @default(now())

  item InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
}

model AutomationRule {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  trigger     EventType
  isActive    Boolean   @default(true)
  actions     Json

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, trigger])
}

model EventLog {
  id         String    @id @default(cuid())
  workspaceId String
  type       EventType
  entityType String
  entityId   String
  payload    Json?
  createdAt  DateTime  @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId, createdAt])
}
